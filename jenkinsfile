pipeline {
    agent any

    environment {
        GITHUB_REPO = 'https://github.com/Nava200/branch-automation'  // Your GitHub repo URL
        GITHUB_CREDENTIALS = 'github-automation'  // Your Jenkins credentials ID for GitHub
    }

    stages {
        stage('Checkout') {
            steps {
                // Explicitly specify the branch (replace 'main' with your target branch if needed)
                git credentialsId: "${GITHUB_CREDENTIALS}", url: "${GITHUB_REPO}", branch: "main"
            }
        }

        stage('Identify Branches to Archive/Remove') {
            steps {
                script {
                    // Get list of all remote branches
                    def branches = sh(script: 'git branch -r', returnStdout: true).trim().split("\n")
                    def branchesToArchive = []
                    def branchesToDelete = []

                    // Loop through the branches to determine which to archive or delete
                    branches.each { branch ->
                        def lastCommitDate = sh(script: "git log -1 --format=%cd ${branch}", returnStdout: true).trim()
                        def lastCommitTimestamp = Date.parse('E MMM dd HH:mm:ss yyyy', lastCommitDate).getTime()
                        def currentTimestamp = new Date().getTime()

                        // Archive if last commit is older than 30 days
                        if ((currentTimestamp - lastCommitTimestamp) > 2592000000) {  // 30 days in milliseconds
                            branchesToArchive.add(branch)
                        } else {
                            branchesToDelete.add(branch)
                        }
                    }

                    // Output the branches that will be archived and deleted
                    echo "Branches to Archive: ${branchesToArchive}"
                    echo "Branches to Delete: ${branchesToDelete}"
                }
            }
        }

        stage('Notify Teams') {
            steps {
                script {
                    def emailSubject = "Branch Deletion Notification"
                    def emailBody = "The following branches have been identified for deletion: ${branchesToDelete.join(', ')}"
                    emailext(
                        subject: emailSubject,
                        body: emailBody,
                        to: "navaneetha.22june@gmail.com"  // Replace with actual recipient emails
                    )
                }
            }
        }
    }
}
