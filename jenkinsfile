pipeline {
    agent any
    
    environment {
        GITHUB_CREDENTIALS = 'github-automation'  // GitHub credentials ID for Jenkins
        REPO_URL = 'https://github.com/Nava200/branch-automation.git'
        BRANCH_NAME = 'main'
    }

    stages {
        stage('Checkout SCM') {
            steps {
                script {
                    // Checkout the Git repository using the defined GitHub credentials
                    checkout([$class: 'GitSCM', 
                        branches: [[name: "*/${BRANCH_NAME}"]], 
                        userRemoteConfigs: [[url: "${REPO_URL}", credentialsId: "${GITHUB_CREDENTIALS}"]]
                    ])
                }
            }
        }

        stage('Identify Branches') {
            steps {
                script {
                    // Get the list of remote branches
                    def branches = sh(script: "git branch -r", returnStdout: true).trim().split("\n")
                    def branchesToArchive = []
                    def branchesToDelete = []

                    // Get the last commit date of the main branch
                    def lastCommitDate = sh(script: "git log -1 --format=%cd origin/${BRANCH_NAME}", returnStdout: true).trim()
                    
                    // Convert the date to seconds
                    def commitTimestamp = sh(script: "date -d '${lastCommitDate}' +%s", returnStdout: true).trim()
                    def currentTimestamp = sh(script: "date +%s", returnStdout: true).trim()

                    // Calculate the age of the branch in days
                    def ageInSeconds = currentTimestamp.toInteger() - commitTimestamp.toInteger()
                    def ageInDays = ageInSeconds / (60 * 60 * 24)
                    
                    // Identify branches to archive based on age
                    branches.each { branch ->
                        // Clean up branch name by removing 'origin/' prefix
                        def branchName = branch.replace("origin/", "").trim()

                        if (branchName != "main") {  // Skip the main branch
                            if (ageInDays > 15) {
                                branchesToArchive.add(branchName)
                            }
                            if (ageInDays > 30) {
                                branchesToDelete.add(branchName)
                            }
                        }
                    }
                    
                    // Output results for debugging
                    echo "Branches to archive: ${branchesToArchive}"
                    echo "Branches to delete: ${branchesToDelete}"
                    
                    // Save the branch lists as environment variables
                    env.BRANCHES_TO_ARCHIVE = branchesToArchive.join(",")
                    env.BRANCHES_TO_DELETE = branchesToDelete.join(",")
                }
            }
        }

        stage('Notify Teams') {
            steps {
                script {
                    // Notify via email if there are branches to archive or delete
                    if (env.BRANCHES_TO_ARCHIVE) {
                        emailext subject: "Branches to Archive", 
                                 body: "Branches to archive: ${env.BRANCHES_TO_ARCHIVE}", 
                                 to: "navaneetha.22june@gmail.com"
                    }
                    if (env.BRANCHES_TO_DELETE) {
                        emailext subject: "Branches to Delete", 
                                 body: "Branches to delete: ${env.BRANCHES_TO_DELETE}", 
                                 to: "navaneetha.22june@gmail.com"
                    }
                }
            }
        }

        stage('Archive Branches') {
            steps {
                script {
                    if (env.BRANCHES_TO_ARCHIVE) {
                        def branchesToArchive = env.BRANCHES_TO_ARCHIVE.split(",")
                        branchesToArchive.each { branch ->
                            // Archive the branch
                            echo "Archiving branch: ${branch}"
                            // Replace this with actual archiving logic if needed
                        }
                    }
                }
            }
        }

        stage('Delete Branches') {
            steps {
                script {
                    if (env.BRANCHES_TO_DELETE) {
                        def branchesToDelete = env.BRANCHES_TO_DELETE.split(",")
                        branchesToDelete.each { branch ->
                            // Delete the branch
                            echo "Deleting branch: ${branch}"
                            // Replace this with actual deletion logic if needed
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            cleanWs()  // Clean workspace after the pipeline runs
        }
    }
}
